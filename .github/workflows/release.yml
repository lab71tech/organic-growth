name: Daily Release

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      dry-run:
        description: 'Preview what would be released without making changes'
        required: false
        default: false
        type: boolean

concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Check for changes since last tag
        id: changes
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "No previous tag found, will release"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            # Count only non-version-bump commits to prevent release loops.
            # The release workflow creates commits starting with "chore: bump version";
            # if those are the only commits since the last tag, there is nothing to release.
            COMMITS=$(git log "$LAST_TAG"..HEAD --oneline --invert-grep --grep="^chore: bump version" | wc -l | tr -d ' ')
            if [ "$COMMITS" -gt 0 ]; then
              echo "Found $COMMITS meaningful commits since $LAST_TAG (excluding version bumps)"
              echo "has_changes=true" >> "$GITHUB_OUTPUT"
            else
              echo "No meaningful changes since $LAST_TAG (only version-bump commits)"
              echo "has_changes=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Bump version
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          BUMP=${{ github.event.inputs.bump || 'patch' }}
          NEW_VERSION=$(node -e "
            const pkg = require('./package.json');
            const [major, minor, patch] = pkg.version.split('.').map(Number);
            const bump = process.argv[1];
            if (bump === 'major') {
              console.log((major + 1) + '.0.0');
            } else if (bump === 'minor') {
              console.log(major + '.' + (minor + 1) + '.0');
            } else {
              console.log(major + '.' + minor + '.' + (patch + 1));
            }
          " "$BUMP")
          npm version "$NEW_VERSION" --no-git-tag-version
          echo "NEW_VERSION=$NEW_VERSION" >> "$GITHUB_ENV"

      - name: Commit version bump and tag
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.dry-run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
          git tag -a "v$NEW_VERSION" -m "v$NEW_VERSION"
          git push origin main --follow-tags

      - name: Create GitHub Release
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.dry-run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release create "v$NEW_VERSION" --generate-notes

      - name: Dry run summary
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.dry-run == 'true'
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            COMMIT_COUNT=$(git rev-list --count HEAD)
          else
            COMMIT_COUNT=$(git log "$LAST_TAG"..HEAD --oneline --invert-grep --grep="^chore: bump version" | wc -l | tr -d ' ')
          fi
          echo "## Dry Run Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Would release:** v$NEW_VERSION" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Commits included:** $COMMIT_COUNT" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Bump type:** ${{ github.event.inputs.bump || 'patch' }}" >> "$GITHUB_STEP_SUMMARY"
          echo ""
          echo "DRY RUN: Would have released v$NEW_VERSION with $COMMIT_COUNT commits (bump: ${{ github.event.inputs.bump || 'patch' }})"
