name: Daily Release

on:
  # schedule:
  #   - cron: '0 12 * * *'  # Re-enable after loop prevention (Stage 3)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Check for changes since last tag
        id: changes
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "No previous tag found, will release"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            COMMITS=$(git rev-list "$LAST_TAG"..HEAD --count)
            if [ "$COMMITS" -gt 0 ]; then
              echo "Found $COMMITS new commits since $LAST_TAG"
              echo "has_changes=true" >> "$GITHUB_OUTPUT"
            else
              echo "No changes since $LAST_TAG"
              echo "has_changes=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Bump patch version
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          NEW_VERSION=$(node -e "
            const pkg = require('./package.json');
            const [major, minor, patch] = pkg.version.split('.').map(Number);
            console.log(major + '.' + minor + '.' + (patch + 1));
          ")
          npm version "$NEW_VERSION" --no-git-tag-version
          echo "NEW_VERSION=$NEW_VERSION" >> "$GITHUB_ENV"

      - name: Commit version bump and tag
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
          git tag "v$NEW_VERSION"
          git push origin main --follow-tags

      - name: Create GitHub Release
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release create "v$NEW_VERSION" --generate-notes
